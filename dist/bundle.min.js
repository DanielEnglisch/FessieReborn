function AudioBundle(){this.dump_land=new Audio("audio/dumpster_land.wav"),this.dump_move=new Audio("audio/dumpster_move.wav"),this.trash_land=new Audio("audio/trash_land.wav"),this.trash_collect=new Audio("audio/trash_collect.wav"),this.dirt1=new Audio("audio/dirt1.wav"),this.dirt2=new Audio("audio/dirt2.wav"),this.dirt3=new Audio("audio/dirt3.wav"),this.dirt4=new Audio("audio/dirt4.wav"),this.music1=new Audio("audio/music1.wav"),this.music2=new Audio("audio/music2.wav"),this.music3=new Audio("audio/music3.wav"),this.walk=new Audio("audio/walk.wav"),this.die=new Audio("audio/die.wav"),this.exit_open=new Audio("audio/exit_open.wav"),this.finish=new Audio("audio/finish.wav"),this.explosion=new Audio("audio/explosion.wav"),this.fire=new Audio("audio/fire.wav"),this.force_field=new Audio("audio/force_field.wav"),this.slime_explosion=new Audio("audio/slime_explosion.wav"),this.slime_squash=new Audio("audio/slime_squash.wav")}var startBackgroundMusic=function(){var s=null;switch(Math.floor(3*Math.random())+1){case 1:s=audio.music1.cloneNode();break;case 2:s=audio.music2.cloneNode();break;case 3:s=audio.music3.cloneNode()}s.addEventListener("ended",function(){startBackgroundMusic()},!1),s.volume=.25,s.play()},playDirt=function(){var s=null;switch(Math.floor(4*Math.random())+1){case 1:s=audio.dirt1.cloneNode();break;case 2:s=audio.dirt2.cloneNode();break;case 3:s=audio.dirt3.cloneNode();break;case 4:s=audio.dirt4.cloneNode()}s.volume=vol_sound,s.play()},playAudio=function(s){var e=s.cloneNode();e.volume=vol_sound,e.play()};const Block={AIR:0,WALL:1,PLAYER:2,DUMPSTER:3,TRASH:4,DIRT:5,EXIT:6,STEEL_WALL:7,SILVER_MONSTER:8,BOMB:9,SEWER:"A",BLUE_WALL:"B",WALL_ORGANIC:"C",TRASH_MONSTER:"D",SLIME_MONSTER:"E",FORCE_FIELD:"F",FIRE_ORB:"G",TOXIC_TRASH:"H"},Explosion={FIRE:0,SLIME:1,TRASH:2,BREATH:3},Direc={UP:0,DOWN:1,LEFT:2,RIGHT:3,NONE:4};var GameObject=function(s,e){this.blockPos=s,this.sourceBlock=s,this.type=e,this.moving=!1,this.oldBlockPos=new Vec(s.x,s.y),this.pos=new Vec(s.x,s.y),this.updateAnimaiton=function(s,e=movementSpeed){return this.pos.x+e<this.blockPos.x?(this.moving=!0,this.pos.x+=e,this.pos.x=Math.round(100*this.pos.x)/100,!1):this.pos.x-e>this.blockPos.x?(this.moving=!0,this.pos.x-=e,this.pos.x=Math.round(100*this.pos.x)/100,!1):this.pos.y+s<this.blockPos.y?(this.moving=!0,this.pos.y+=s,this.pos.y=Math.round(100*this.pos.y)/100,!1):this.pos.y-s>this.blockPos.y?(this.moving=!0,this.pos.y-=s,this.pos.y=Math.round(100*this.pos.y)/100,!1):(this.sourceBlock=new Vec(this.blockPos.x,this.blockPos.y),this.pos.x=this.blockPos.x,this.pos.y=this.blockPos.y,this.oldBlockPos.x=this.blockPos.x,this.oldBlockPos.y=this.blockPos.y,this.moving=!1,!0)}};function Fallable(s,e){Fallable.super_.call(this,s,e),this.fallEvent=function(){playAudio(audio.trash_land),isPlayer(this.blockPos.x,this.blockPos.y+1)&&player.kill()},this.move=function(s,e,i=!1){if(!this.moving&&0==e){var o=!0;if(!isAir(this.blockPos.x+s,this.blockPos.y+e))return!1;var t=this.blockPos;return fallables.forEach(function(i){t.x+s==i.blockPos.x&&t.y+e==i.blockPos.y&&(o=!1)}),monsters.forEach(function(i){Math.abs(i.pos.x-t.x+s)<=2+i.hitbox&&Math.abs(i.pos.y-t.y+e)<=1&&(i.pos.x-t.x+s>0&&s>0||i.pos.x-t.x+s<0&&s<0)&&(o=!1)}),o?(this.blockPos.x+=s,this.blockPos.y+=e,i&&playAudio(audio.dump_move),!0):!1}},this.isFalling=!1,this.wasFalling=!1,this.update=function(){this.updateAnimaiton(gravity)&&(this.isFalling&&!isAir(this.blockPos.x,this.blockPos.y+1)&&(this.isFalling=!1,this.fallEvent()),isFallable(this.blockPos.x,this.blockPos.y+1)?isAir(this.blockPos.x+1,this.blockPos.y)&&isAir(this.blockPos.x+1,this.blockPos.y+1)?belowCanSlip(this)||this.move(1,0):isAir(this.blockPos.x-1,this.blockPos.y)&&isAir(this.blockPos.x-1,this.blockPos.y+1)&&(belowCanSlip(this)||this.move(-1,0)):(isAir(this.blockPos.x,this.blockPos.y+1)||isMonster(this.blockPos.x,this.blockPos.y+1)&&!isPlayer(this.blockPos.x,this.blockPos.y+1))&&(this.blockPos=new Vec(this.blockPos.x,this.blockPos.y+1),this.isFalling=!0))}}inherits(Fallable,GameObject);var belowCanSlip=function(s){var e=getFallable(s.blockPos.x,s.blockPos.y+1);return!!getFallable(s.blockPos.x,s.blockPos.y+2)&&(!(!isAir(e.blockPos.x+1,e.blockPos.y)||!isAir(e.blockPos.x+1,e.blockPos.y+1))||(!(!isAir(e.blockPos.x-1,e.blockPos.y)||!isAir(e.blockPos.x-1,e.blockPos.y+1))||void 0))};function Monster(s,e){Monster.super_.call(this,s,-1),this.dir=Direc.RIGHT,this.hitbox=1,this.type=e,this.movementSpeed=.015,this.kill=function(){switch(score+=200,monsters.splice(monsters.indexOf(this),1),this.type){case Block.SILVER_MONSTER:spawnExplosion(posToBlock(this.pos),Explosion.FIRE);break;case Block.TRASH_MONSTER:spawnExplosion(posToBlock(this.pos),Explosion.TRASH);break;case Block.SLIME_MONSTER:playAudio(audio.slime_squash),spawnExplosion(posToBlock(this.pos),Explosion.SLIME)}},this.update=function(){}}function Collectable(s,e){Collectable.super_.call(this,s,e),this.collect=function(){console.log("Collected "+this.type)}}inherits(Monster,GameObject),inherits(Collectable,Fallable);var isFallable=function(s,e){var i=!1;return fallables.forEach(function(o){s==o.blockPos.x&&e==o.blockPos.y&&(i=!0)}),i},isTrash=function(s,e){var i=!1;return fallables.forEach(function(o){s==o.blockPos.x&&e==o.blockPos.y&&o.type==Block.TRASH&&(i=!0)}),i},isMonster=function(s,e){var i=!1;return monsters.forEach(function(o){s==o.blockPos.x&&e==o.blockPos.y&&(i=!0)}),i},isMonsterAlt=function(s,e,i){var o=!1;return monsters.forEach(function(t){(t!=s&&e==t.blockPos.x&&i==t.blockPos.y||e==t.oldBlockPos.x&&i==t.oldBlockPos.y)&&(o=!0)}),o},isCollectable=function(s,e){var i=getFallable(s,e);return null!=i&&(i.type==Block.TRASH||i.type==Block.TOXIC_TRASH||i.type==Block.BOMB||i.type==Block.FORCE_FIELD||i.type==Block.FIRE_ORB)},getFallable=function(s,e){var i=null;return fallables.forEach(function(o){s==o.blockPos.x&&e==o.blockPos.y&&(i=o)}),i},getTrash=function(s,e){var i=null;return fallables.forEach(function(o){s==o.blockPos.x&&e==o.blockPos.y&&o.type==Block.TRASH&&(i=o)}),i},getMonster=function(s,e){var i=null;return monsters.forEach(function(o){s==o.blockPos.x&&e==o.blockPos.y&&(i=o)}),i},isPlayer=function(s,e){return player.blockPos.x==s&&player.blockPos.y==e},isWall=function(s,e){return world[s][e]==Block.WALL||world[s][e]==Block.STEEL_WALL||isBreakable(s,e)},isBreakable=function(s,e){return world[s][e]==Block.SEWER||world[s][e]==Block.BLUE_WALL||world[s][e]==Block.WALL_ORGANIC},isExit=function(s,e){return exit.pos.x==s&&exit.pos.y==e},isAir=function(s,e){return!(world[s][e]!=Block.AIR||isFallable(s,e)||isExit(s,e)||isMonster(s,e)||isPlayer(s,e)||world[s][e]==Block.BOMB)};const vol_music=.2,vol_sound=.7,EXPLOSION_DELAY=100;var canvas=document.getElementById("screen"),context=null;const scale=64,gravity=.05,movementSpeed=.075;var items_left=0,num_bombs=0,num_fires=0,score=0,timeOuts=[],xOffset=0,yOffset=0,fallables=[],player=null,world=[],exit=null,monsters=[],keys=[],explosion_overlays=[];const tex=new TexturesBundle,audio=new AudioBundle;var time=Date.now();const ups=120;function Dumpster(s){Dumpster.super_.call(this,s,Block.DUMPSTER),this.image=tex.dumpster.cloneImage(),this.draw=function(s){s.drawImage(this.image,this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke()},this.fallEvent=function(){playAudio(audio.dump_land),isPlayer(this.blockPos.x,this.blockPos.y+1)&&player.kill()}}function Trash(s){Trash.super_.call(this,s,Block.TRASH),this.image=tex.trash.cloneImage(),this.draw=function(s){s.drawImage(this.image,this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke()},this.collect=function(){score+=100,fallables.splice(fallables.indexOf(this),1),items_left>0&&items_left--,0==items_left&&exit.open(),playAudio(audio.trash_collect)}}function ToxicTrash(s){ToxicTrash.super_.call(this,s,Block.TOXIC_TRASH),this.image=tex.toxic_trash.cloneImage(),this.fallEvent=function(){spawnExplosion(this.blockPos,Explosion.SLIME),fallables.splice(fallables.indexOf(this),1)}}function ForceField(s){ForceField.super_.call(this,s,Block.FORCE_FIELD),this.draw=function(s){s.drawImage(tex.force_field.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke()},this.collect=function(){playAudio(audio.force_field),player.forceField=!0,timeOuts.push(setTimeout(function(){player.forceField=!1},1e4)),fallables.splice(fallables.indexOf(this),1)}}function FireOrb(s){FireOrb.super_.call(this,s,Block.FIRE_ORB),this.draw=function(s){s.drawImage(tex.fire_orb.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke()},this.collect=function(){num_fires++,playAudio(audio.trash_collect),fallables.splice(fallables.indexOf(this),1)}}function Exit(s){this.open=function(){this.isOpen||(playAudio(audio.exit_open),this.isOpen=!0)},this.isOpen=!1,this.pos=s,this.draw=function(s){this.isOpen?s.drawImage(tex.exit_open,this.pos.x*scale,this.pos.y*scale,scale,scale):s.drawImage(tex.exit_closed,this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke(),player.hasFinished&&(tex.fessie_exit.update(),s.drawImage(tex.fessie_exit.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale)),s.stroke()}}function ExplosionOverlay(s,e,i,o,t=!0,l=function(){}){this.duration=i,this.type=o,this.isDeadly=t,this.callback=l,this.animation=Object.assign({},e),this.timeUntil=Date.now()+i,this.blockPos=s,this.update=function(){this.animation.update(),Date.now()>=this.timeUntil&&(this.callback(this.blockPos.x,this.blockPos.y),explosion_overlays.splice(explosion_overlays.indexOf(this),1))},this.draw=function(s){s.drawImage(this.animation.getImage(),this.blockPos.x*scale,this.blockPos.y*scale,scale,scale),s.stroke()}}function Bomb(s){Bomb.super_.call(this,s,Block.BOMB),this.image=tex.bomb,this.draw=function(s){s.drawImage(this.image,this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke()},this.collect=function(){num_bombs++,fallables.splice(fallables.indexOf(this),1),playAudio(audio.trash_collect)}}function Player(s){Player.super_.call(this,s,Block.PLAYER),this.looking=Direc.NONE,this.isDead=!1,this.isGrabbing=!1,this.forceField=!1,this.grabTimeout=null,this.grab=function(s,e){if(!this.isGrabbing&&!this.moving){if(this.isGrabbing=!0,isCollectable(this.blockPos.x+s,this.blockPos.y+e))getFallable(this.blockPos.x+s,this.blockPos.y+e).collect();else world[this.blockPos.x+s][this.blockPos.y+e]==Block.DIRT&&(world[this.blockPos.x+s][this.blockPos.y+e]=0,playDirt());1==s&&0==e?player.looking=Direc.RIGHT:-1==s&&0==e?player.looking=Direc.LEFT:0==s&&1==e?player.looking=Direc.DOWN:0==s&&-1==e&&(player.looking=Direc.UP);var i=this;timeOuts.push(i.grabTimeout=setTimeout(function(){i.isGrabbing=!1,i.looking=Direc.NONE},250))}},this.move=function(s,e){if(this.isGrabbing=!1,null!=this.grabTimeout&&clearTimeout(this.grabTimeout),!this.moving){var i=!0;if(!isWall(this.blockPos.x+s,this.blockPos.y+e)&&world[this.blockPos.x+s][this.blockPos.y+e]!=Block.BOMB){if(world[this.blockPos.x+s][this.blockPos.y+e]==Block.DIRT)world[this.blockPos.x+s][this.blockPos.y+e]=Block.AIR,playDirt();else if(isExit(this.blockPos.x+s,this.blockPos.y+e)){if(0==exit.isOpen)return;audio.finish.addEventListener("ended",function(){levelTesting?window.location.href="./editor/?data="+levelString:(setScore(nextLevel-1,score),window.location.href="?lvl="+nextLevel)},!0),audio.finish.play(),this.isDead=!0,this.hasFinished=!0}else{var o=this.blockPos;fallables.forEach(function(t,l,a){Fallable.falling?(o.x+s==t.blockPos.x&&o.y+e==t.blockPos.y||o.x+s==t.blockPos.x&&o.y+e==t.blockPos.y-1)&&(i=!1):o.x+s==t.blockPos.x&&o.y+e==t.blockPos.y&&(isCollectable(t.blockPos.x,t.blockPos.y)?t.collect():-1!=e&&t.move(s,e,!0)||(i=!1))})}i&&(this.blockPos.x+=s,this.blockPos.y+=e,1==s&&0==e?player.looking=Direc.RIGHT:-1==s&&0==e?player.looking=Direc.LEFT:0==s&&1==e?player.looking=Direc.DOWN:0==s&&-1==e&&(player.looking=Direc.UP),playAudio(audio.walk),this.moving=!0)}}},this.hasFinished=!1,this.update=function(){if(this.isDead&&!this.hasFinished)return this.pos.y+=.1,void(this.blockPos.y+=1);this.updateAnimaiton(movementSpeed),tex.fessie_left.update(),tex.fessie_right.update(),tex.fessie_up.update(),tex.fessie_down.update(),tex.fessie_idle_left.update(),tex.fessie_idle_right.update(),tex.fessie_idle_center.update(),this.isGrabbing?(tex.fessie_grab_down.update(),tex.fessie_grab_left.update(),tex.fessie_grab_right.update(),tex.fessie_grab_up.update()):(tex.fessie_grab_down.reset(),tex.fessie_grab_left.reset(),tex.fessie_grab_right.reset(),tex.fessie_grab_up.reset()),refreshOffset()},this.draw=function(s){if(this.isDead&&!this.hasFinished)return s.drawImage(tex.fessie_dead,this.pos.x*scale,this.pos.y*scale,scale,scale),void s.stroke();if(!this.hasFinished){switch(this.looking){case Direc.UP:this.moving?s.drawImage(tex.fessie_up.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):this.isGrabbing?s.drawImage(tex.fessie_grab_up.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):s.drawImage(tex.fessie_idle_center.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale);break;case Direc.DOWN:this.moving?s.drawImage(tex.fessie_down.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):this.isGrabbing?s.drawImage(tex.fessie_grab_down.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):s.drawImage(tex.fessie_idle_center.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale);break;case Direc.LEFT:this.moving?s.drawImage(tex.fessie_left.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):this.isGrabbing?s.drawImage(tex.fessie_grab_left.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):s.drawImage(tex.fessie_idle_left.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale);break;case Direc.RIGHT:this.moving?s.drawImage(tex.fessie_right.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):this.isGrabbing?s.drawImage(tex.fessie_grab_right.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale):s.drawImage(tex.fessie_idle_right.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale);break;default:s.drawImage(tex.fessie_idle_center.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale)}this.forceField&&s.drawImage(tex.force_shield.getImage(),this.pos.x*scale,this.pos.y*scale,scale,scale),s.stroke()}},this.fireBlocks=0,this.fire=function(s){if(!(0!=this.fireBlocks||num_fires<=0)){for(var e=s;world[this.blockPos.x+e][this.blockPos.y]==Block.AIR||world[this.blockPos.x+e][this.blockPos.y]==Block.DIRT;)world[this.blockPos.x+e][this.blockPos.y]=Block.AIR,this.fireBlocks++,s>0?explosion_overlays.push(new ExplosionOverlay(new Vec(this.blockPos.x+e,this.blockPos.y),tex.fire_right,400,Explosion.BREATH,!0,decrFireBlocks)):explosion_overlays.push(new ExplosionOverlay(new Vec(this.blockPos.x+e,this.blockPos.y),tex.fire_left,400,Explosion.BREATH,!0,decrFireBlocks)),e+=s;this.looking=s>0?Direc.RIGHT:Direc.LEFT,num_fires--,playAudio(audio.fire)}},this.kill=function(){this.forceField||this.isDead||(playAudio(audio.die),this.isDead=!0,setTimeout(function(){reloadLevel()},2e3))}}inherits(Dumpster,Fallable),inherits(Trash,Collectable),inherits(ToxicTrash,Trash),inherits(ForceField,Collectable),inherits(FireOrb,Collectable),inherits(Bomb,Collectable),inherits(Player,GameObject);var decrFireBlocks=function(s,e){player.fireBlocks--},setScore=function(s,e){if("undefined"!=typeof Storage){var i=JSON.parse(localStorage.getItem("fessie_scoreboard"));null==i&&(console.log("Created new array!"),i=new Array),i.forEach(function(e,o,t){e.lvl===s&&i.splice(o,1)}),i.push(new Score(s,e)),i.sort(compare),localStorage.setItem("fessie_scoreboard",JSON.stringify(i))}};function compare(s,e){return s.lvl<e.lvl?-1:s.lvl>e.lvl?1:0}var printScoreTable=function(s){if("undefined"!=typeof Storage){var e=JSON.parse(localStorage.getItem("fessie_scoreboard"));null==e&&(e=new Array,localStorage.setItem("fessie_scoreboard",JSON.stringify(e)));var i="<table><tr><th>Level</th><th>Score</th></tr>";e.forEach(function(s){i+="<tr><td>"+s.lvl+"</td><td>"+s.value+"</td>"}),i+="</table>"}document.getElementById(s).innerHTML=i};function Score(s,e){this.lvl=s,this.value=e}function SilverMonster(s){SilverMonster.super_.call(this,s,Block.SILVER_MONSTER),this.dir=Direc.RIGHT,this.hitbox=.65,this.movementSpeed=.01,this.update=function(){if(this.updateAnimaiton(this.movementSpeed,this.movementSpeed)){var s=0,e=0;this.dir==Direc.RIGHT?isAir(this.blockPos.x+1,this.blockPos.y)||isPlayer(this.blockPos.x+1,this.blockPos.y)&&!isMonsterAlt(this.blockPos.x+1,this.blockPos.y)?s++:Math.floor(2*Math.random())+1==1?this.dir=Direc.DOWN:this.dir=Direc.LEFT:this.dir==Direc.DOWN?isAir(this.blockPos.x,this.blockPos.y+1)||isPlayer(this.blockPos.x,this.blockPos.y+1)&&!isMonsterAlt(this.blockPos.x,this.blockPos.y+1)?e++:Math.floor(2*Math.random())+1==1?this.dir=Direc.RIGHT:this.dir=Direc.UP:this.dir==Direc.LEFT?isAir(this.blockPos.x-1,this.blockPos.y)||isPlayer(this.blockPos.x-1,this.blockPos.y)&&!isMonsterAlt(this.blockPos.x-1,this.blockPos.y)?s--:Math.floor(2*Math.random())+1==1?this.dir=Direc.UP:this.dir=Direc.RIGHT:this.dir==Direc.UP&&(isAir(this.blockPos.x,this.blockPos.y-1)||isPlayer(this.blockPos.x,this.blockPos.y-1)&&!isMonsterAlt(this.blockPos.x,this.blockPos.y-1)?e--:Math.floor(2*Math.random())+1==1?this.dir=Direc.LEFT:this.dir=Direc.DOWN);var i=!1;(!isAir(this.blockPos.x+s,this.blockPos.y+e)&&!isPlayer(this.blockPos.x+s,this.blockPos.y+e)||isMonsterAlt(this,this.blockPos.x+s,this.blockPos.y+e))&&(i=!0);var o=this.blockPos;fallables.forEach(function(t){Math.abs(o.x+s-t.pos.x)<1&&Math.abs(o.y+e-t.pos.y)<1&&(i=!0)}),world[this.blockPos.x+s][this.blockPos.y+e]==Block.EXIT&&(i=!0,console.log("EXIT IN THE WAY")),i||(this.oldBlockPos.x=this.blockPos.x,this.oldBlockPos.y=this.blockPos.y,this.blockPos.x+=s,this.blockPos.y+=e)}},this.draw=function(s){s.drawImage(tex.silver_monster_anim.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale),s.stroke()}}function SlimeMonster(s){SlimeMonster.super_.call(this,s,Block.SLIME_MONSTER),this.dir=Direc.RIGHT,this.looking=Direc.NONE,this.hitbox=.6,this.movementSpeed=.01,this.update=function(){if(this.updateAnimaiton(this.movementSpeed,this.movementSpeed)){var s=0,e=0;this.dir==Direc.RIGHT?isAir(this.blockPos.x+1,this.blockPos.y)||isPlayer(this.blockPos.x+1,this.blockPos.y)&&!isMonsterAlt(this.blockPos.x+1,this.blockPos.y)?s++:Math.floor(2*Math.random())+1==1?this.dir=Direc.DOWN:this.dir=Direc.LEFT:this.dir==Direc.DOWN?isAir(this.blockPos.x,this.blockPos.y+1)||isPlayer(this.blockPos.x,this.blockPos.y+1)&&!isMonsterAlt(this.blockPos.x,this.blockPos.y+1)?e++:Math.floor(2*Math.random())+1==1?this.dir=Direc.RIGHT:this.dir=Direc.UP:this.dir==Direc.LEFT?isAir(this.blockPos.x-1,this.blockPos.y)||isPlayer(this.blockPos.x-1,this.blockPos.y)&&!isMonsterAlt(this.blockPos.x-1,this.blockPos.y)?s--:Math.floor(2*Math.random())+1==1?this.dir=Direc.UP:this.dir=Direc.RIGHT:this.dir==Direc.UP&&(isAir(this.blockPos.x,this.blockPos.y-1)||isPlayer(this.blockPos.x,this.blockPos.y-1)&&!isMonsterAlt(this.blockPos.x,this.blockPos.y-1)?e--:Math.floor(2*Math.random())+1==1?this.dir=Direc.LEFT:this.dir=Direc.DOWN);var i=!1;(!isAir(this.blockPos.x+s,this.blockPos.y+e)&&!isPlayer(this.blockPos.x+s,this.blockPos.y+e)||isMonsterAlt(this,this.blockPos.x+s,this.blockPos.y+e))&&(i=!0);var o=this.blockPos;fallables.forEach(function(t){Math.abs(o.x+s-t.pos.x)<1&&Math.abs(o.y+e-t.pos.y)<1&&(i=!0)}),world[this.blockPos.x+s][this.blockPos.y+e]==Block.EXIT&&(i=!0,console.log("EXIT IN THE WAY")),i||(this.oldBlockPos.x=this.blockPos.x,this.oldBlockPos.y=this.blockPos.y,this.blockPos.x+=s,this.blockPos.y+=e,1==s&&0==e?this.looking=Direc.RIGHT:-1==s&&0==e?this.looking=Direc.LEFT:0==s&&1==e?this.looking=Direc.DOWN:0==s&&-1==e&&(this.looking=Direc.UP))}},this.draw=function(s){switch(this.looking){case Direc.LEFT:s.drawImage(tex.slime_monster_left.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale);break;case Direc.RIGHT:s.drawImage(tex.slime_monster_right.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale);break;default:s.drawImage(tex.slime_monster_center.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale)}s.stroke()}}function TexturesBundle(){this.loadingImages=0,this.allTexturesLoading=!1,this.fessie_neutral=new Image,this.fessie_dead=new Image,this.wall=new Image,this.air=new Image,this.dirt=new Image,this.exit_open=new Image,this.exit_closed=new Image,this.steel_wall=new Image,this.bomb=new Image,this.blue_wall=new Image,this.sewer=new Image,this.wall_organic=new Image,this.trash=new VariantTexture,this.toxic_trash=new VariantTexture,this.dumpster=new VariantTexture,this.slime_explosion=new Animation(500),this.fire_explosion=new Animation(1e3),this.silver_monster_anim=new Animation(1500),this.fessie_right=new Animation(500),this.fessie_left=new Animation(500),this.fessie_up=new Animation(500),this.fessie_down=new Animation(500),this.fessie_idle_left=new Animation(500),this.fessie_idle_right=new Animation(500),this.fessie_idle_center=new Animation(500),this.fessie_grab_down=new Animation(250),this.fessie_grab_left=new Animation(250),this.fessie_grab_right=new Animation(250),this.fessie_grab_up=new Animation(250),this.fessie_exit=new Animation(2500),this.trash_monster_center=new Animation(250),this.trash_monster_left=new Animation(250),this.trash_monster_right=new Animation(250),this.slime_monster_center=new Animation(500),this.slime_monster_left=new Animation(500),this.slime_monster_right=new Animation(500),this.slime_plop=new Animation(200),this.slime_plop_reverse=new Animation(200),this.force_field=new Animation(500),this.force_shield=new Animation(500),this.fire_orb=new Animation(500),this.fire_left=new Animation(500),this.fire_right=new Animation(500),this.callback=null,this.load=function(s,e){this.callback=e,this.fessie_neutral=this.blockloadImage(s+"fessie_neutral.png"),this.fessie_dead=this.blockloadImage(s+"fessie_dead.png"),this.wall=this.blockloadImage(s+"wall.png"),this.exit_closed=this.blockloadImage(s+"exit_closed.png"),this.exit_open=this.blockloadImage(s+"exit_open.png"),this.trash.load(s+"trash/"),this.toxic_trash.load(s+"toxic_trash/"),this.dumpster.load(s+"dumpster/"),this.air=this.blockloadImage(s+"air.png"),this.dirt=this.blockloadImage(s+"dirt.png"),this.steel_wall=this.blockloadImage(s+"steel_wall.png"),this.bomb=this.blockloadImage(s+"bomb.png"),this.blue_wall=this.blockloadImage(s+"bluewall.png"),this.sewer=this.blockloadImage(s+"sewer.png"),this.wall_organic=this.blockloadImage(s+"wall_organic.png"),this.slime_explosion.load(s+"slime_explosion/"),this.fire_explosion.load(s+"fire_explosion/"),this.silver_monster_anim.load(s+"silver_monster/"),this.fessie_right.load(s+"fessie_right/"),this.fessie_left.load(s+"fessie_left/"),this.fessie_down.load(s+"fessie_down/"),this.fessie_up.load(s+"fessie_up/"),this.fessie_idle_center.load(s+"fessie_idle_center/"),this.fessie_idle_left.load(s+"fessie_idle_left/"),this.fessie_idle_right.load(s+"fessie_idle_right/"),this.fessie_grab_up.load(s+"fessie_grab_up/"),this.fessie_grab_down.load(s+"fessie_grab_down/"),this.fessie_grab_left.load(s+"fessie_grab_left/"),this.fessie_grab_right.load(s+"fessie_grab_right/"),this.fessie_exit.load(s+"fessie_exit/"),this.trash_monster_center.load(s+"trash_monster_center/"),this.trash_monster_left.load(s+"trash_monster_left/"),this.trash_monster_right.load(s+"trash_monster_right/"),this.slime_monster_center.load(s+"slime_monster_center/"),this.slime_monster_left.load(s+"slime_monster_left/"),this.slime_monster_right.load(s+"slime_monster_right/"),this.slime_plop.load(s+"slime_plop/"),this.slime_plop_reverse.load(s+"slime_plop_reverse/"),this.force_field.load(s+"force_field/"),this.force_shield.load(s+"force_shield/"),this.fire_left.load(s+"fire_left/"),this.fire_right.load(s+"fire_right/"),this.fire_orb.load(s+"fire_orb/"),this.allTexturesLoading=!0},this.blockloadImage=function(s){var e=this,i=new Image;return i.src=s,this.loadingImages++,i.addEventListener("error",function(){console.error("Error loading "+s),e.loadingImages--,0==e.loadingImages&&e.allTexturesLoading&&e.callback()}),i.onload=function(){e.loadingImages--,0==e.loadingImages&&e.allTexturesLoading&&e.callback()},i}}function Animation(s){this.imageId=0,this.duration=s,this.reset=function(){this.imageId=0},this.getImage=function(){return this.images[this.imageId]},this.images=[],this.cooldownUntil=Date.now()+this.duration/this.images.length,this.load=function(s){for(var e=loadJSON(s+"info.json").num_images,i=0;i<e;i++)this.images[i]=tex.blockloadImage(s+""+i+".png");this.cooldownUntil=Date.now()+this.duration/this.images.length},this.update=function(){Date.now()>=this.cooldownUntil&&(this.imageId=(this.imageId+1)%this.images.length,this.cooldownUntil=Date.now()+this.duration/this.images.length)}}function VariantTexture(){this.cloneImage=function(){return this.images[Math.floor(Math.random()*this.images.length)]},this.images=[],this.load=function(s){for(var e=loadJSON(s+"info.json").num_images,i=0;i<e;i++)this.images[i]=tex.blockloadImage(s+""+i+".png")}}function TrashMonster(s){TrashMonster.super_.call(this,s,Block.TRASH_MONSTER),this.dir=Direc.RIGHT,this.looking=Direc.NONE,this.hitbox=.75,this.movementSpeed=.03,this.update=function(){if(this.updateAnimaiton(this.movementSpeed,this.movementSpeed)){var s=0,e=0;Math.sqrt(Math.pow(this.blockPos.x-player.blockPos.x,2)+Math.pow(this.blockPos.y-player.blockPos.y,2))<=6?this.blockPos.x-player.blockPos.x>0&&(isAir(this.blockPos.x-1,this.blockPos.y+e)||isPlayer(this.blockPos.x-1,this.blockPos.y+e))?s--:this.blockPos.x-player.blockPos.x<0&&(isAir(this.blockPos.x+1,this.blockPos.y+e)||isPlayer(this.blockPos.x+1,this.blockPos.y+e))?s++:this.blockPos.y-player.blockPos.y>0&&(isAir(this.blockPos.x,this.blockPos.y-1)||isPlayer(this.blockPos.x,this.blockPos.y-1))?e--:this.blockPos.y-player.blockPos.y<0&&(isAir(this.blockPos.x,this.blockPos.y+1)||isPlayer(this.blockPos.x,this.blockPos.y+1))&&e++:this.dir==Direc.RIGHT?isAir(this.blockPos.x+1,this.blockPos.y)||isPlayer(this.blockPos.x+1,this.blockPos.y)&&!isMonsterAlt(this.blockPos.x+1,this.blockPos.y)?s++:Math.floor(2*Math.random())+1==1?this.dir=Direc.DOWN:this.dir=Direc.LEFT:this.dir==Direc.DOWN?isAir(this.blockPos.x,this.blockPos.y+1)||isPlayer(this.blockPos.x,this.blockPos.y+1)&&!isMonsterAlt(this.blockPos.x,this.blockPos.y+1)?e++:Math.floor(2*Math.random())+1==1?this.dir=Direc.RIGHT:this.dir=Direc.UP:this.dir==Direc.LEFT?isAir(this.blockPos.x-1,this.blockPos.y)||isPlayer(this.blockPos.x-1,this.blockPos.y)&&!isMonsterAlt(this.blockPos.x-1,this.blockPos.y)?s--:Math.floor(2*Math.random())+1==1?this.dir=Direc.UP:this.dir=Direc.RIGHT:this.dir==Direc.UP&&(isAir(this.blockPos.x,this.blockPos.y-1)||isPlayer(this.blockPos.x,this.blockPos.y-1)&&!isMonsterAlt(this.blockPos.x,this.blockPos.y-1)?e--:Math.floor(2*Math.random())+1==1?this.dir=Direc.LEFT:this.dir=Direc.DOWN);var i=!1;(!isAir(this.blockPos.x+s,this.blockPos.y+e)&&!isPlayer(this.blockPos.x+s,this.blockPos.y+e)||isMonsterAlt(this,this.blockPos.x+s,this.blockPos.y+e))&&(i=!0);var o=this.blockPos;fallables.forEach(function(t){Math.abs(o.x+s-t.pos.x)<1&&Math.abs(o.y+e-t.pos.y)<1&&(i=!0)}),world[this.blockPos.x+s][this.blockPos.y+e]==Block.EXIT&&(i=!0,console.log("EXIT IN THE WAY")),i||(this.oldBlockPos.x=this.blockPos.x,this.oldBlockPos.y=this.blockPos.y,this.blockPos.x+=s,this.blockPos.y+=e,1==s&&0==e?this.looking=Direc.RIGHT:-1==s&&0==e?this.looking=Direc.LEFT:0==s&&1==e?this.looking=Direc.DOWN:0==s&&-1==e&&(this.looking=Direc.UP))}},this.draw=function(s){switch(this.looking){case Direc.LEFT:s.drawImage(tex.trash_monster_left.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale);break;case Direc.RIGHT:s.drawImage(tex.trash_monster_right.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale);break;default:s.drawImage(tex.trash_monster_center.getImage(),this.pos.x*scale+0,this.pos.y*scale+0,scale,scale)}s.stroke()}}function inherits(s,e){s.super_=e,s.prototype=Object.create(e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}})}inherits(SilverMonster,Monster),inherits(SlimeMonster,Monster),inherits(TrashMonster,Monster);var Vec=function(s,e){this.x=s,this.y=e},posToBlock=function(s){return new Vec(Math.floor(s.x),Math.floor(s.y))};function loadJSON(s){var e=loadTextFileAjaxSync(s,"application/json");return JSON.parse(e)}function loadTextFileAjaxSync(s,e){var i=new XMLHttpRequest;return i.open("GET",s,!1),null!=e&&i.overrideMimeType&&i.overrideMimeType(e),i.send(),200==i.status?i.responseText:null}var reloadLevel=function(){loadLevel()},loadLevel=function(){timeOuts.forEach(function(s){clearTimeout(s)}),world=[],player=null,fallables=[],keys=[],items_left=0,score=0,exit=null,monsters=[],num_bombs=0,num_fires=0,explosion_overlays=[];for(var s=levelString.split("X"),e=0,i=0;i<s.length;i++){for(var o=[],t=0;t<s[i].length;t++)o[t]=s[i].charAt(t),e=s[i].length;world[i]=o,e++}console.log("Loaded level with size "+(e-1)+"x"+s.length);for(i=0;i<world.length;i++)for(t=0;t<world[0].length;t++)world[i][t]==Block.PLAYER?(player=new Player(new Vec(i,t),Direc.NONE),refreshOffset(),world[i][t]=0):world[i][t]==Block.DUMPSTER?(fallables.push(new Dumpster(new Vec(i,t))),world[i][t]=0):world[i][t]==Block.TRASH?(fallables.push(new Trash(new Vec(i,t))),world[i][t]=0,items_left++):world[i][t]==Block.TOXIC_TRASH?(fallables.push(new ToxicTrash(new Vec(i,t))),world[i][t]=0,items_left++):world[i][t]==Block.FORCE_FIELD?(fallables.push(new ForceField(new Vec(i,t))),world[i][t]=0):world[i][t]==Block.FIRE_ORB?(fallables.push(new FireOrb(new Vec(i,t))),world[i][t]=0):world[i][t]==Block.EXIT?exit=new Exit(new Vec(i,t)):world[i][t]==Block.SILVER_MONSTER?(monsters.push(new SilverMonster(new Vec(i,t))),world[i][t]=0):world[i][t]==Block.SLIME_MONSTER?(monsters.push(new SlimeMonster(new Vec(i,t))),world[i][t]=0):world[i][t]==Block.TRASH_MONSTER?(monsters.push(new TrashMonster(new Vec(i,t))),world[i][t]=0):world[i][t]==Block.BOMB&&(fallables.push(new Bomb(new Vec(i,t))),world[i][t]=0);if(!player||!exit)throw alert("World is missing an exit or a player!"),new Error("World is missing an exit or a player!");0==items_left&&exit.open()},initWorld=function(){loadLevel()};document.onreadystatechange=(()=>{"complete"===document.readyState&&main()});var loadingtime=Date.now(),main=function(){addEvents(),initCanvas(),tex.load("img/",function(){console.log("Loaded textures."),initWorld(),startBackgroundMusic(),console.log("Loading took: "+(Date.now()-loadingtime)/1e3+"s"),loop()})},loop=function(){Date.now()-time>=1e3/120&&(update(),time=Date.now()),redraw(),requestAnimationFrame(loop)},refreshOffset=function(){xOffset=0,yOffset=0,xOffset-=player.pos.x*scale-canvas.width/2+1*scale,yOffset-=player.pos.y*scale-canvas.height/2+0*scale,xOffset=Math.round(xOffset),yOffset=Math.round(yOffset)},addEvents=function(){window.addEventListener("resize",function(s){canvas.width=window.innerWidth,canvas.height=window.innerHeight-40,refreshOffset()}),window.onkeydown=function(s){s.repeat||(keys[s.keyCode]=!0)},window.onkeyup=function(s){s.repeat||(keys[s.keyCode]=!1)}},update=function(){tex.silver_monster_anim.update(),tex.trash_monster_center.update(),tex.trash_monster_left.update(),tex.trash_monster_right.update(),tex.slime_monster_center.update(),tex.slime_monster_left.update(),tex.slime_monster_right.update(),tex.force_shield.update(),tex.force_field.update(),tex.fire_orb.update(),fallables.forEach(function(s){s.isFalling&&monsters.forEach(function(e){Math.abs(s.pos.x-e.pos.x)<e.hitbox&&Math.abs(s.pos.y-e.pos.y)<e.hitbox&&e.kill()})}),player.isDead||monsters.forEach(function(s){Math.abs(s.pos.x-player.pos.x)<s.hitbox&&Math.abs(s.pos.y-player.pos.y)<s.hitbox&&(s.kill(),player.kill())}),explosion_overlays.forEach(function(s){Math.abs(s.timeUntil-Date.now())>s.duration-100||s.isDeadly&&(!player.isDead&&s.type!=Explosion.BREATH&&Math.abs(s.blockPos.x-player.pos.x)<1&&Math.abs(s.blockPos.y-player.pos.y)<1&&player.kill(),monsters.forEach(function(e){Math.abs(s.blockPos.x-e.pos.x)<1&&Math.abs(s.blockPos.y-e.pos.y)<1&&e.kill()}),s.type!=Explosion.FIRE&&s.type!=Explosion.BREATH||fallables.forEach(function(e){isCollectable(s.blockPos.x,s.blockPos.y)&&Math.abs(s.blockPos.x-e.pos.x)<1&&Math.abs(s.blockPos.y-e.pos.y)<1&&fallables.splice(fallables.indexOf(e),1)}))}),player.update(),fallables.forEach(function(s){s.update()}),monsters.forEach(function(s){s.update()}),explosion_overlays.forEach(function(s){s.update()}),player.isDead||(keys[17]?keys[38]||keys[87]?player.grab(0,-1):keys[40]||keys[83]?player.grab(0,1):keys[37]||keys[65]?player.grab(-1,0):(keys[39]||keys[68])&&player.grab(1,0):keys[16]?keys[37]||keys[65]?player.fire(-1):(keys[39]||keys[68])&&player.fire(1):keys[38]||keys[87]?player.move(0,-1):keys[40]||keys[83]?player.move(0,1):keys[37]||keys[65]?player.move(-1,0):(keys[39]||keys[68])&&player.move(1,0),keys[32]&&(spawnBombOnPlayer(),keys[32]=!1),keys[82]&&(reloadLevel(),keys[82]=!1),keys[27]&&(levelTesting&&(window.location.href="./editor/?data="+levelString),keys[27]=!1))},initCanvas=function(){var s=document.getElementById("screen");s.width=window.innerWidth,s.height=window.innerHeight-40,(context=s.getContext("2d"))||console.error("Canvas init failed!")},redraw=function(){context.clearRect(0,0,window.innerWidth,window.innerHeight),context.save(),context.translate(xOffset,yOffset);for(var s=0;s<world.length;s++)for(var e=0;e<world[0].length;e++)world[s][e]==Block.WALL?context.drawImage(tex.wall,s*scale,e*scale,scale,scale):world[s][e]==Block.STEEL_WALL?context.drawImage(tex.steel_wall,s*scale,e*scale,scale,scale):world[s][e]==Block.BOMB?context.drawImage(tex.bomb,s*scale,e*scale,scale,scale):world[s][e]==Block.DIRT?context.drawImage(tex.dirt,s*scale,e*scale,scale,scale):world[s][e]==Block.SEWER?context.drawImage(tex.sewer,s*scale,e*scale,scale,scale):world[s][e]==Block.BLUE_WALL?context.drawImage(tex.blue_wall,s*scale,e*scale,scale,scale):world[s][e]==Block.WALL_ORGANIC?context.drawImage(tex.wall_organic,s*scale,e*scale,scale,scale):context.drawImage(tex.air,s*scale,e*scale,scale,scale),context.stroke();exit.draw(context),explosion_overlays.forEach(function(s){s.draw(context)}),fallables.forEach(function(s){s.draw(context)}),monsters.forEach(function(s){s.draw(context)}),player.draw(context),context.restore(),context.fillStyle="black",context.fillRect(0,canvas.height-50,canvas.width,50),context.stroke(),context.font="24px Arial",context.textAlign="center",context.textBaseline="middle",context.fillStyle="rgb(248, 132, 0)",context.fillText("Müll übrig: "+items_left,canvas.width/2,canvas.height-25),context.fillText("Bomben: "+num_bombs,canvas.width/3,canvas.height-25),context.fillText("Feuer: "+num_fires,canvas.width/5,canvas.height-25),context.fillText("Punkte: "+score,2*canvas.width/3,canvas.height-25),player.isDead&&!player.hasFinished&&(context.font="72px Arial",context.fillStyle="red",context.strokeStyle="black",context.fillText("Nochmal!",canvas.width/2,canvas.height/2),context.strokeText("Nochmal!",canvas.width/2,canvas.height/2))},spawnExplosion=function(s,e){e==Explosion.SLIME?playAudio(audio.slime_explosion):playAudio(audio.explosion);for(var i=s.x-1;i<=s.x+1;i++)for(var o=s.y-1;o<=s.y+1;o++)switch(world[i][o]==Block.DIRT?world[i][o]=Block.AIR:e==Explosion.FIRE&&isBreakable(i,o)&&(world[i][o]=Block.AIR),e){case Explosion.FIRE:explosion_overlays.push(new ExplosionOverlay(new Vec(i,o),tex.fire_explosion,1e3,Explosion.FIRE));break;case Explosion.SLIME:explosion_overlays.push(new ExplosionOverlay(new Vec(i,o),tex.slime_plop,200,Explosion.SLIME,!1,addSlime));break;case Explosion.TRASH:var t=Math.random();isAir(i,o)&&t<.125&&fallables.push(new Trash(new Vec(i,o)))}},addSlime=function(s,e){explosion_overlays.push(new ExplosionOverlay(new Vec(s,e),tex.slime_explosion,15e3,Explosion.SLIME,!0,addPlop))},addPlop=function(s,e){explosion_overlays.push(new ExplosionOverlay(new Vec(s,e),tex.slime_plop_reverse,200,Explosion.SLIME,!1))},spawnBombOnPlayer=function(){var s=Object.assign({},player.blockPos);if(num_bombs>0&&world[s.x][s.y]!=Block.BOMB){var e=!1;if(monsters.forEach(function(i){Math.abs(i.pos.x-s.x)<1&&Math.abs(i.pos.y-s.y)<1&&(e=!0)}),e)return;world[s.x][s.y]=Block.BOMB,playAudio(audio.fire),num_bombs--,timeOuts.push(setTimeout(function(){spawnExplosion(s,Explosion.FIRE),world[s.x][s.y]=Block.AIR},3e3))}};